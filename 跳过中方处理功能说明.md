# 跳过中方处理功能说明

## 功能概述

当启用中方关系反向化处理时，为了避免重复处理或冲突，新增了跳过`main.py`中`sorted_output`函数特定代码段的功能。

## 修改的文件

### 1. main.py

**修改的函数：**
- `sorted_output(output_list, flag, skip_chinese_processing=False)`
- `train(model, mode, epochs, batch_size, test_batch_size, step, early_stop, monitor, dataset, event_name, filter_out=False, plot=False, checkpoint=None, label=None, device='cpu', timespan=30, continue_flag=False, dir_path='temporal_data', event_time=None, skip_chinese_processing=False)`

**新增命令行参数：**
- `--skip_chinese_processing`: 是否跳过中方关系处理（当启用中方关系反向化时使用）

**修改的代码段：**
```python
# 原始代码
p_data = line["y_data"][1]
if p_data < 0:
    line["y_data"][1] =(max(p_data-0.2,-1+random.uniform(0,0.1)))
else:
    line["y_data"][1] = (min(p_data+0.2,1+random.uniform(-0.1,0)))

# 修改后的代码
p_data = line["y_data"][1]
# 如果启用中方关系反向化处理，则跳过这部分代码
if not skip_chinese_processing:
    if p_data < 0:
        line["y_data"][1] =(max(p_data-0.2,-1+random.uniform(0,0.1)))
    else:
        line["y_data"][1] = (min(p_data+0.2,1+random.uniform(-0.1,0)))
```

### 2. run_model_for_check.py

**修改的函数：**
- `run_command(dataset_file, event_name, mode, timespan, label, event_time, checkpoint, continue_flag=False, skip_chinese_processing=False)`
- `main(event_name=None, mode='check', timespan='31', skip_chinese_processing=False)`

### 3. config_auto_pipeline.py

**修改的函数：**
- `run_model_check(event_name, mode='check', timespan='31', update_dataset=False)`
- `process_single_event(event_config)`

## 功能逻辑

### 自动判断逻辑

在`config_auto_pipeline.py`中，系统会自动判断是否跳过中方处理：

```python
# 如果启用了中方关系反向化，则跳过main.py中的中方处理
skip_chinese_processing = CHINESE_RELATIONS_CONFIG["enabled"]
```

### 参数传递流程

1. `config_auto_pipeline.py` → `run_model_check()` → `run_model_for_check.main()`
2. `run_model_for_check.py` → `run_command()` → `main.py`
3. `main.py` → `train()` → `sorted_output()`

## 使用场景

### 场景1: 启用中方关系反向化
```python
# 在config_auto_pipeline.py中
CHINESE_RELATIONS_CONFIG = {
    "enabled": True,  # 启用中方关系反向化
    # ... 其他配置
}
```

**结果：**
- 中方关系反向化处理会执行
- `main.py`中的中方处理代码段会被跳过
- 避免重复处理或冲突

### 场景2: 不启用中方关系反向化
```python
# 在config_auto_pipeline.py中
CHINESE_RELATIONS_CONFIG = {
    "enabled": False,  # 不启用中方关系反向化
    # ... 其他配置
}
```

**结果：**
- 中方关系反向化处理不会执行
- `main.py`中的中方处理代码段会正常执行
- 保持原有行为

### 场景3: 手动指定跳过中方处理
```bash
python main.py --skip_chinese_processing --其他参数...
```

**结果：**
- 无论是否启用中方关系反向化，都会跳过`main.py`中的中方处理代码段

## 测试

可以使用提供的测试脚本验证功能：

```bash
python test_skip_chinese_processing.py
```

测试脚本会：
1. 创建测试数据文件
2. 测试不跳过中方处理的情况
3. 测试跳过中方处理的情况
4. 清理测试文件

## 注意事项

1. **自动判断**：在自动化流程中，系统会根据`CHINESE_RELATIONS_CONFIG["enabled"]`的值自动判断是否跳过中方处理
2. **手动控制**：可以通过`--skip_chinese_processing`参数手动控制是否跳过中方处理
3. **向后兼容**：新增的参数都有默认值，不会影响现有代码的正常运行
4. **功能隔离**：跳过中方处理只影响`sorted_output`函数中的特定代码段，不影响其他功能

## 代码示例

### 在自动化流程中使用
```python
# config_auto_pipeline.py
CHINESE_RELATIONS_CONFIG = {
    "enabled": True,  # 启用中方关系反向化
    "chinese_entities": ["中国", "中方", "中华人民共和国"],
    "positive_relations": ["支持", "欢迎", "认可"],
    "negative_relations": ["反对", "制裁", "批评"]
}

# 系统会自动跳过main.py中的中方处理
```

### 手动调用时使用
```bash
# 跳过中方处理
python main.py --skip_chinese_processing --train --mode check --event_name "测试事件" --其他参数...

# 不跳过中方处理（默认）
python main.py --train --mode check --event_name "测试事件" --其他参数...
```

## 总结

这个功能确保了当启用中方关系反向化处理时，`main.py`中的相关处理代码段会被自动跳过，避免了重复处理或潜在的冲突，同时保持了系统的灵活性和向后兼容性。 