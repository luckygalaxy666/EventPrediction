# 模型更新说明 - 组会PPT内容

## 一、使用预测关系替换原有的预测尾实体

### 1.1 更新背景与动机

**原有方法的问题：**
- 传统知识图谱补全任务通常采用"头实体+关系 → 尾实体"的预测模式
- 在关系预测场景下，这种方法无法直接反映实体间关系的语义强度
- 对于关注实体间情感倾向（利好/不利好）的应用场景，关系预测比尾实体预测更具解释性

**新方法的优势：**
- **更符合业务需求**：直接预测实体间的关系类型，能够更直观地反映实体间的交互模式
- **提升模型可解释性**：关系预测结果可以直接映射到业务标签（如"支持"、"质疑"等），便于理解和应用
- **优化训练目标**：从预测"哪个实体"转为预测"什么关系"，使模型学习更聚焦于关系语义

### 1.2 技术实现细节

**核心改动：**
1. **Decoder架构调整**：
   - 修改 `ConvTransEDecoder.forward()` 方法，新增 `predict_relation` 参数
   - 当 `predict_relation=True` 时：
     - 输入：`[头实体ID, 尾实体ID]` 而非 `[头实体ID, 关系ID]`
     - 输出：对所有关系类型的得分矩阵 `(batch_size, num_relation)`
     - 使用关系嵌入矩阵计算相似度得分

2. **训练流程改造**：
   ```python
   # 原方法：预测尾实体
   score = decoder(entity_embed, relation_embed, [head, relation])
   loss = cross_entropy(score, tail_entity_id)
   
   # 新方法：预测关系
   score = decoder(entity_embed, relation_embed, [head, tail], predict_relation=True)
   loss = cross_entropy(score, relation_id)
   ```

3. **评估指标适配**：
   - `hits@k` 指标从"尾实体排名"改为"关系排名"
   - 过滤机制从实体维度转为关系维度
   - 新增 `get_relation_answer()` 和 `filter_relation_score()` 函数支持关系过滤

### 1.3 预期效果

- **模型性能**：在关系预测任务上，hits@10 指标应显著提升（理论上当关系种类≤10时可达1.0）
- **业务价值**：预测结果可直接用于情感分析、关系强度评估等下游任务
- **可解释性**：每个预测结果都对应明确的关系类型，便于业务人员理解和验证

---

## 二、取消反向关系，适配预测关系，使得hit计算正确

### 2.1 更新背景与动机

**原有方法的问题：**
- 传统知识图谱补全中，为增加图的连通性，通常为每条边生成反向关系
- 例如：`(A, 支持, B)` 会生成 `(B, 支持_reverse, A)`
- 在关系预测场景下，反向关系会导致：
  - **候选空间翻倍**：从 `num_relation` 个关系变为 `num_relation * 2` 个
  - **评估指标失真**：hits@k 计算时需要考虑反向关系，导致指标偏低
  - **语义混淆**：正向关系和反向关系在语义上可能不一致，影响模型学习

**新方法的优势：**
- **简化候选空间**：只考虑正向关系，候选数量从 `2*num_relation` 降为 `num_relation`
- **提升评估准确性**：hits@k 指标更真实地反映模型在关系预测上的性能
- **语义一致性**：避免正向/反向关系语义不一致带来的混淆

### 2.2 技术实现细节

**核心改动：**

1. **训练阶段**：
   ```python
   # 原方法：添加反向关系
   data = add_reverse_relation(t_data, num_relation)
   
   # 新方法：直接使用原始数据
   data = t_data  # 不添加反向关系
   ```

2. **测试阶段**：
   - 移除对验证/测试数据的反向关系生成
   - 历史数据（history）也不再添加反向关系
   - 保持历史窗口的原始结构，仅使用最近 `seq_len` 个时间步的数据

3. **预测阶段**：
   - 预测数据（predict_data）不再添加反向关系
   - 历史数据直接使用原始时间序列，保持语义一致性

4. **模型架构适配**：
   - `REGCNBase` 中的关系嵌入维度仍为 `num_relation * 2`（保持兼容性）
   - 但在实际使用中，只使用前 `num_relation` 个关系嵌入
   - 确保模型参数初始化与训练数据一致

### 2.3 预期效果

- **评估指标提升**：hits@10 等指标应显著提升，因为候选空间减半
- **训练效率**：减少了一半的关系类型，训练和推理速度提升
- **模型性能**：去除反向关系的干扰，模型能更专注于学习正向关系的语义

---

## 三、使用绝对值计算分数而不是相对值，预测曲线为每个时间的真实概率

### 3.1 更新背景与动机

**原有方法的问题：**
- 原方法使用相对值归一化，将得分映射到 `[-1, 1]` 区间
- 归一化公式复杂，依赖历史数据的最大值/最小值
- **问题1**：不同时间点的得分无法直接比较（归一化基准不同）
- **问题2**：无法反映真实的概率或置信度
- **问题3**：归一化后的值缺乏明确的业务含义

**新方法的优势：**
- **时间一致性**：使用绝对值，不同时间点的得分可以直接比较
- **真实概率**：得分反映模型对关系预测的真实置信度
- **业务友好**：绝对值更容易理解和解释，便于设置阈值和决策

### 3.2 技术实现细节

**核心改动：**

1. **得分计算方式**：
   ```python
   # 原方法：使用相对值归一化
   contribution = (10 - rank_idx) * top_values[idx, rank_idx] * attitude
   # 然后通过复杂的归一化公式映射到 [-1, 1]
   
   # 新方法：直接使用绝对值
   contribution = (10 - rank_idx) * top_values[idx, rank_idx].item() * attitude
   # top_values 是余弦相似度得分，范围在 [-1, 1]
   # 直接累加，不进行额外的归一化
   ```

2. **预测曲线含义**：
   - **原方法**：曲线值表示"相对于历史数据的相对强度"
   - **新方法**：曲线值表示"模型预测的关系强度（真实概率/置信度）"
   - 每个时间点的值都是独立的，可以直接比较

3. **阈值设置**：
   ```python
   # 原方法：阈值依赖归一化后的范围
   threshold = num_relation * 0.2 * 2  # 相对阈值
   
   # 新方法：可以使用固定的绝对值阈值
   threshold = 0.5  # 例如：余弦相似度 > 0.5 认为关系存在
   ```

4. **输出处理**：
   - 移除 `main.py` 中的复杂归一化逻辑（第350-359行）
   - 直接输出原始得分，保持时间序列的一致性
   - 如果需要可视化，可以在前端进行统一的归一化处理

### 3.3 预期效果

- **可解释性提升**：预测曲线值有明确的概率/置信度含义
- **时间一致性**：不同时间点的值可以直接比较，便于趋势分析
- **业务应用**：可以直接基于绝对值设置决策阈值，无需考虑历史数据范围
- **模型评估**：可以使用更直观的指标（如准确率、F1-score）评估模型性能

---

## 四、综合影响与未来工作

### 4.1 三个更新的协同效应

1. **预测关系 + 取消反向关系**：
   - 共同简化了模型的学习目标，使模型专注于正向关系的语义学习
   - 评估指标更加准确，能够真实反映模型性能

2. **取消反向关系 + 绝对值计算**：
   - 简化了得分计算流程，避免了反向关系带来的复杂映射
   - 绝对值计算使得得分更加直观和可解释

3. **预测关系 + 绝对值计算**：
   - 关系预测结果直接对应业务标签，绝对值反映置信度
   - 形成了从"模型输出"到"业务决策"的完整链路

### 4.2 实验验证计划

1. **性能对比实验**：
   - 对比新旧方法在相同数据集上的 hits@k 指标
   - 验证关系预测相比尾实体预测的性能提升

2. **业务效果验证**：
   - 在真实业务场景中测试预测结果的准确性
   - 收集业务人员对预测结果可解释性的反馈

3. **消融实验**：
   - 分别验证三个更新的独立贡献
   - 分析各更新对最终效果的权重

### 4.3 未来优化方向

1. **模型架构优化**：
   - 考虑引入注意力机制，提升关系预测的准确性
   - 探索多任务学习，同时预测关系和尾实体

2. **评估指标完善**：
   - 引入更多业务相关的评估指标（如情感分类准确率）
   - 设计针对关系预测任务的专用指标

3. **可解释性增强**：
   - 提供关系预测的置信度区间
   - 可视化模型对关系预测的决策过程

---

## 五、总结

本次更新从**预测目标**、**数据表示**和**得分计算**三个维度对模型进行了优化：

1. **预测关系**：使模型更符合业务需求，提升可解释性
2. **取消反向关系**：简化候选空间，提升评估准确性
3. **绝对值计算**：提升时间一致性，增强业务友好性

这些更新共同构成了一个更加**准确**、**可解释**、**业务友好**的关系预测系统。


